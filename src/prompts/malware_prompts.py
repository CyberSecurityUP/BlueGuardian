"""Specialized prompts for malware analysis.

This module contains carefully crafted prompts for analyzing malicious software,
designed to get accurate, actionable intelligence from AI models.
"""

MALWARE_ANALYSIS_SYSTEM_PROMPT = """You are an expert malware analyst with deep knowledge of:
- Windows PE/EXE file formats and structures
- Linux ELF binaries
- Malware families, tactics, techniques, and procedures (TTPs)
- MITRE ATT&CK framework
- Reverse engineering and static analysis
- Indicators of Compromise (IOCs)
- Threat intelligence

Your role is to analyze potentially malicious files and provide accurate, actionable intelligence.

CRITICAL RULES:
1. Base ALL conclusions on the actual data provided - never speculate or hallucinate
2. If you're uncertain, say so explicitly with confidence levels
3. Distinguish between confirmed findings vs. possible interpretations
4. Focus on Blue Team defensive use - help defenders understand and respond to threats
5. Extract specific, actionable IOCs (IPs, domains, hashes, registry keys, mutexes)
6. Map behaviors to MITRE ATT&CK techniques when applicable
7. Never execute code or open URLs - analyze statically only
8. Highlight anti-analysis techniques if detected

OUTPUT FORMAT:
- Start with a clear verdict (Malicious/Suspicious/Clean/Unknown) and confidence (0-100%)
- Provide a brief executive summary (2-3 sentences)
- Detail technical findings with evidence
- List all IOCs discovered
- Map to MITRE ATT&CK techniques
- Recommend defensive actions

Remember: Accuracy is paramount. If data is ambiguous or missing, state that clearly."""

MALWARE_PE_ANALYSIS_PROMPT = """Analyze this Windows PE (Portable Executable) file based on the following static analysis data:

FILE INFORMATION:
{file_info}

PE HEADERS:
{pe_headers}

SECTIONS:
{sections}

IMPORTS:
{imports}

EXPORTS:
{exports}

STRINGS (suspicious):
{strings}

ENTROPY ANALYSIS:
{entropy}

{virustotal_data}

TASKS:
1. **Verdict**: Determine if this is Malicious/Suspicious/Clean (with confidence %)
2. **Malware Family**: Identify or suggest possible malware family/variant
3. **Capabilities**: What can this malware do? (e.g., keylogging, C2, persistence)
4. **Packing/Obfuscation**: Detect packing, obfuscation, or anti-analysis techniques
5. **IOCs**: Extract ALL indicators:
   - IP addresses and ports
   - Domain names and URLs
   - Registry keys
   - File paths
   - Mutexes
   - Service names
6. **MITRE ATT&CK**: Map behaviors to specific techniques (e.g., T1055, T1082)
7. **Persistence Mechanisms**: How does it maintain presence?
8. **Network Activity**: Communication patterns, C2 infrastructure
9. **Anti-Analysis**: VM detection, debugger detection, timing checks
10. **Recommendations**: Specific defensive actions for Blue Team

Be thorough but concise. Cite specific evidence for each claim."""

MALWARE_ELF_ANALYSIS_PROMPT = """Analyze this Linux ELF (Executable and Linkable Format) binary:

FILE INFORMATION:
{file_info}

ELF HEADERS:
{elf_headers}

SECTIONS:
{sections}

SYMBOLS:
{symbols}

STRINGS (suspicious):
{strings}

{virustotal_data}

TASKS:
1. **Verdict**: Malicious/Suspicious/Clean (confidence %)
2. **Type**: Identify malware type (rootkit, backdoor, cryptominer, etc.)
3. **Capabilities**: What functionality is present?
4. **Persistence**: cron, systemd, init.d, rc.local, etc.
5. **IOCs**: Extract indicators (IPs, domains, file paths, network activity)
6. **MITRE ATT&CK**: Map to Linux-specific techniques
7. **Privilege Escalation**: SUID, capabilities, exploits
8. **Recommendations**: Detection and mitigation strategies

Focus on evidence from the static analysis data provided."""

MALWARE_TRIAGE_PROMPT = """Perform rapid triage on this file to determine priority:

BASIC INFO:
{file_info}

HASHES:
- MD5: {md5}
- SHA1: {sha1}
- SHA256: {sha256}

{virustotal_data}

QUICK ASSESSMENT:
1. **Threat Level**: Critical/High/Medium/Low/Benign
2. **Priority**: Should this be analyzed in-depth immediately? (Yes/No + reason)
3. **Quick IOCs**: Any obvious indicators?
4. **Recommended Analysis**: What deeper analysis is needed?

Keep it brief - this is triage only."""

MALWARE_IOC_EXTRACTION_PROMPT = """Extract ALL Indicators of Compromise (IOCs) from this analysis data:

{analysis_data}

Extract and categorize:

1. **Network IOCs**:
   - IPv4/IPv6 addresses (with ports if present)
   - Domain names
   - URLs
   - Email addresses

2. **File IOCs**:
   - File hashes (MD5, SHA1, SHA256)
   - File paths
   - File names

3. **Registry IOCs** (Windows):
   - Registry keys
   - Registry values

4. **System IOCs**:
   - Mutexes
   - Named pipes
   - Service names
   - Process names

5. **Behavioral IOCs**:
   - User agents
   - HTTP methods/patterns
   - SSL/TLS certificates

Format as JSON with:
- type: IOC type
- value: The indicator
- confidence: 0.0-1.0
- context: Where/how it was found

Only extract IOCs with HIGH confidence - no speculation."""

MALWARE_MITRE_MAPPING_PROMPT = """Map the observed behaviors to MITRE ATT&CK techniques:

OBSERVED BEHAVIORS:
{behaviors}

IMPORTS/API CALLS:
{api_calls}

For each relevant behavior, provide:
1. **Technique ID**: (e.g., T1055)
2. **Technique Name**: (e.g., Process Injection)
3. **Evidence**: Specific evidence from the data
4. **Confidence**: How certain are you? (High/Medium/Low)

Focus on techniques actually evidenced by the data, not theoretical possibilities.

Common mappings to consider:
- Persistence: T1547 (Boot/Logon), T1053 (Scheduled Task)
- Defense Evasion: T1055 (Process Injection), T1027 (Obfuscation)
- Discovery: T1082 (System Info), T1083 (File Discovery)
- Collection: T1056 (Input Capture), T1113 (Screen Capture)
- C2: T1071 (Application Layer), T1573 (Encrypted Channel)
- Exfiltration: T1041 (C2 Channel), T1048 (Alternative Protocol)

Be specific and evidence-based."""

MALWARE_FAMILY_IDENTIFICATION_PROMPT = """Identify the malware family based on these characteristics:

FILE HASH: {file_hash}

CHARACTERISTICS:
{characteristics}

BEHAVIORAL PATTERNS:
{patterns}

{virustotal_data}

Identify:
1. **Malware Family**: Name (e.g., Emotet, TrickBot, Cobalt Strike)
2. **Variant/Version**: If identifiable
3. **Confidence**: Percentage (0-100%)
4. **Evidence**: What specific traits match this family?
5. **Known Campaigns**: Any associated threat actors or campaigns?
6. **Alternative Possibilities**: Other families this could be (with confidence)

Known family characteristics to consider:
- Emotet: Modular, document droppers, polymorphic
- TrickBot: Banking trojan, info stealer, C2 beaconing
- Cobalt Strike: Beacon, SMB named pipes, process injection
- Ransomware: File encryption, ransom notes, specific extensions

Only identify families you're confident about. If unsure, list possibilities."""

MALWARE_SANDBOX_ANALYSIS_PROMPT = """Analyze the behavioral telemetry from sandbox execution:

PROCESS ACTIVITY:
{process_activity}

FILE SYSTEM:
{file_system}

REGISTRY:
{registry}

NETWORK:
{network}

Analyze:
1. **Execution Flow**: What happened step-by-step?
2. **Persistence**: How does it survive reboots?
3. **Process Injection**: Any injection, hollowing, or DLL injection?
4. **Network Behavior**: C2 communication, beaconing intervals, protocols
5. **Data Exfiltration**: What data was collected/sent?
6. **Lateral Movement**: Attempts to spread or move laterally?
7. **Anti-Sandbox**: Did it detect the sandbox? How?

Provide timeline and causality between events."""

def format_prompt(prompt_template: str, **kwargs) -> str:
    """Format a prompt template with provided arguments.

    Args:
        prompt_template: Template string with {placeholders}
        **kwargs: Values to fill in

    Returns:
        Formatted prompt
    """
    # Replace missing keys with "N/A"
    safe_kwargs = {}
    for key in kwargs:
        value = kwargs[key]
        if value is None or value == "":
            safe_kwargs[key] = "N/A"
        else:
            safe_kwargs[key] = value

    return prompt_template.format(**safe_kwargs)
